<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desk Lamp | Blue Cozy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #00e5ff; --bg: #020617; --card: rgba(15, 23, 42, 0.9); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; background: var(--bg); color: white;
            font-family: 'Inter', sans-serif;
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        body::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 70vw; height: 70vw;
            background: radial-gradient(circle, rgba(0, 229, 255, 0.05) 0%, transparent 70%);
            transform: translate(-50%, -50%); z-index: -1;
        }
        .container {
            width: 320px; padding: 2rem; border-radius: 30px;
            background: var(--card); border: 1px solid rgba(255,255,255,0.05);
            text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4); position: relative;
        }
        h1 { font-weight: 300; letter-spacing: 2px; font-size: 1rem; margin-bottom: 2rem; opacity: 0.6; }
        
        .lamp-btn {
            width: 100px; height: 100px; border-radius: 50%; border: none;
            background: #1e293b; cursor: pointer; transition: 0.4s;
            margin: 0 auto 2rem; display: flex; align-items: center; justify-content: center;
        }
        .lamp-btn svg { width: 40px; fill: #475569; transition: 0.4s; }
        
        /* Solid Shine */
        .lamp-btn.active { background: var(--blue); box-shadow: 0 0 40px rgba(0,229,255,0.4); }
        .lamp-btn.active svg { fill: #000; }
        
        /* Pulse for Pending ON */
        .lamp-btn.pending { border: 2px solid var(--blue); animation: pulse 2s infinite; }
        .lamp-btn.pending svg { fill: var(--blue); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .timer-box { background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 20px; }
        #countdown { font-size: 1.8rem; color: var(--blue); margin-bottom: 1rem; display: none; }
        .inputs { display: flex; justify-content: center; gap: 8px; margin-bottom: 1rem; }
        input { width: 50px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 8px; text-align: center; padding: 8px 0; }
        .btn { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: white; cursor: pointer; font-size: 0.7rem; font-weight: 600; }
        
        #overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: var(--bg); border-radius: 30px; z-index: 5; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div class="container">
    <div id="overlay">
        <h1>DESK LAMP</h1>
        <button class="btn" onclick="connect()" style="width:140px; border-color:var(--blue); color:var(--blue)">CONNECT</button>
    </div>

    <h1>DESK LAMP</h1>
    <button class="lamp-btn" id="lampBtn" onclick="toggle()">
        <svg viewBox="0 0 24 24"><path d="M12,2A7,7 0 0,0 5,9C5,11.38 6.19,13.47 8,14.74V17A1,1 0 0,0 9,18H15A1,1 0 0,0 16,17V14.74C17.81,13.47 19,11.38 19,9A7,7 0 0,0 12,2M9,21A1,1 0 0,0 10,22H14A1,1 0 0,0 15,21V20H9V21Z" /></svg>
    </button>

    <div class="timer-box">
        <div id="countdown">00:00:00</div>
        <div class="inputs">
            <input type="number" id="h" placeholder="0">
            <input type="number" id="m" placeholder="0">
            <input type="number" id="s" placeholder="0">
        </div>
        <div style="display:flex; gap:8px">
            <button class="btn" onclick="setTimer('ON')">ON AFTER</button>
            <button class="btn" onclick="setTimer('OFF')">OFF AFTER</button>
        </div>
    </div>
</div>

<script>
    let char, timerInt, timeLeft = 0, targetIsOn = false;

    async function connect() {
        try {
            const device = await navigator.bluetooth.requestDevice({ filters: [{ services: ["0000ffe0-0000-1000-8000-00805f9b34fb"] }] });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService("0000ffe0-0000-1000-8000-00805f9b34fb");
            char = await service.getCharacteristic("0000ffe1-0000-1000-8000-00805f9b34fb");
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (e) => {
                let m = new TextDecoder().decode(e.target.value).trim();
                console.log("Recv:", m);
                if(m.startsWith("STATE:")) updateUI(m.split(":")[1] === "1");
                if(m.startsWith("T_VAL:") || m.startsWith("T_START:")) {
                    let p = m.split(":");
                    timeLeft = parseInt(p[1]);
                    targetIsOn = p[2] === "1";
                    if(timeLeft > 0) startClock();
                }
                if(m === "T_DONE") { 
                    updateUI(targetIsOn); 
                    timeLeft = 0; 
                    stopClock(); 
                }
            });
            document.getElementById('overlay').style.display = 'none';
            setTimeout(() => send("SYNC"), 600);
        } catch(e) { alert("Fail"); }
    }

    async function send(m) { if(char) await char.writeValue(new TextEncoder().encode(m+"\n")); }
    function toggle() { send(document.getElementById('lampBtn').classList.contains('active') ? "0" : "1"); }
    
    function updateUI(on) {
        const btn = document.getElementById('lampBtn');
        btn.classList.remove('pending');
        btn.classList.toggle('active', on);
    }

    function startClock() {
        clearInterval(timerInt);
        const btn = document.getElementById('lampBtn');
        if(targetIsOn && !btn.classList.contains('active')) btn.classList.add('pending');
        document.getElementById('countdown').style.display = 'block';
        timerInt = setInterval(() => {
            if(timeLeft <= 0) return stopClock();
            timeLeft--;
            let h = Math.floor(timeLeft/3600).toString().padStart(2,'0');
            let m = Math.floor((timeLeft%3600)/60).toString().padStart(2,'0');
            let s = (timeLeft%60).toString().padStart(2,'0');
            document.getElementById('countdown').innerText = `${h}:${m}:${s}`;
        }, 1000);
    }

    function stopClock() {
        clearInterval(timerInt);
        document.getElementById('countdown').style.display = 'none';
        document.getElementById('lampBtn').classList.remove('pending');
    }

    function setTimer(type) {
        let total = (parseInt(document.getElementById('h').value)||0)*3600 + (parseInt(document.getElementById('m').value)||0)*60 + (parseInt(document.getElementById('s').value)||0);
        if(total > 0) {
            targetIsOn = (type === 'ON');
            send(type + ":" + total);
        }
    }
</script>
</body>
</html>
